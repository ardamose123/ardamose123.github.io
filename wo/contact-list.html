<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="semantic/dist/semantic.css" charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.js" charset="utf-8"></script>
    <script src="semantic/dist/semantic.js" charset="utf-8"></script>
    <script src="js/eseecard.js" charset="utf-8"></script>
    <title>Wö</title>
    <style>
      html, body, .pusher {
        min-height: 100vh;
      }
      .separated.segments {
        margin-top: 2.8em;
      }

      .right.floated {
        float: right;
      }
    </style>
    <script type="text/javascript">
      var categories = {};
      var categoryFilter = [];

      var cts = listContacts();
      Object.keys(cts).map(function(contact) {
        var contactCategories = cts[contact].categories.split(',');

        contactCategories.forEach(function(category) {
          if (categories[category])
            categories[category] = categories[category] + 1;
          else
            categories[category] = 1;
        });
      });
    </script>
  </head>
  <body>
    <div class="ui large right vertical menu sidebar">
      <div class="item">
        <div class="header">Categorías</div>
        <div class="menu">
          <a class="item" id="no-category-filter-option" onclick="categoryFilter=[]; refreshContacts();">
            <div class="ui label">
              <script>document.write(Object.keys(cts).length);</script>
            </div>
            Todos los contactos
          </a>
          <script type="text/javascript">
            for (category in categories)
            {
              document.write('<a class="category-filter item" data-category="' + category + '" onclick="toggleCategoryFilter(\'' + category + '\');"><div class="ui label">' + categories[category] + '</div>' + category + '</a>');
            }
          </script>
        </div>
      </div>
      <div class="item">
        <div class="ui transparent small icon input">
          <input type="text" placeholder="Hashtag o nombre...">
          <i class="search link icon"></i>
        </div>
      </div>
    </div>
    <div class="pusher">
      <div class="ui inverted blue top fixed borderless menu">
        <div class="item" onclick="window.location = 'landing-page.html'"><i class="left arrow icon"></i></div>
        <div class="item">Lista de contactos</div>
        <div class="right menu">
          <div class="item" onclick="window.location = 'new-contact.html'"><i class="add user icon"></i></div>
          <div class="item" onclick="showFilteringSidebar();"><i class="filter icon"></i></div>
        </div>
      </div>
      <div class="ui separated segments" id="contact-list">
      </div>
    </div>
    <div id="remove-contact-modal" class="ui basic modal">
      <i class="close icon"></i>
      <div class="ui icon header">
        <i class="trash icon"></i>
        Eliminar contacto
      </div>
      <div class="content">
        <div class="description">
          <p>¿Desea eliminar a &ldquo;<span id="victim-name"></span>&rdquo; de sus contactos?</p>
          <input type="hidden" id ="victim-id">
        </div>
      </div>
      <div class="actions">
        <div class="two fluid ui inverted buttons">
          <div class="ui red basic inverted button" onclick="$('#remove-contact-modal').modal('hide');">
            <i class="remove icon"></i>
            No
          </div>
          <div class="ui green basic inverted button" onclick="removeContact()">
            <i class="checkmark icon"></i>
            Sí
          </div>
        </div>
      </div>
    </div>
    <div id="no-contacts-modal" class="ui modal">
      <div class="ui icon header">
        <i class="add user icon" onclick="window.location = 'new-contact.html';"></i>
        ¡Bienvenido!
        <p>Agregue su primer contacto <a href="new-contact.html">aquí</a></p>
      </div>
    </div>
    <script type="text/javascript">
      $(function() {
        $('.ui.sticky').sticky({ context: '.ui.items' });
        $('.ui.dropdown').dropdown();
        $('.ui.sidebar').sidebar({
          transition: 'overlay',
          mobileTransition: 'overlay'
        });

        // $('.ui.sidebar .item').click(hideFilteringSidebar);
        $('#remove-contact-modal').modal();
        $('#no-contacts-modal').modal({ closable: false });

        refreshContacts();
      });

      function showFilteringSidebar() {
        $('.ui.sidebar').sidebar('show');
        return false;
      }

      function hideFilteringSidebar() {
        $('.ui.sidebar').sidebar('hide');
        return false;
      }

      function toggleCategoryFilter(category)
      {
        var theTarget = $('a[data-category="' + category + '"]');

        var idx = categoryFilter.indexOf(category);
        if (idx === -1)
        {
          theTarget.addClass('active orange');
          theTarget.children('.label').addClass('orange');
          categoryFilter.push(category);
        }
        else
        {
          theTarget.removeClass('active orange');
          theTarget.children('.label').removeClass('orange');
          categoryFilter.splice(idx, 1);
        }

        refreshContacts();
      }

      function refreshContacts() {
        if (categoryFilter.length === 0)
        {
          $('#no-category-filter-option').addClass('active orange');
          $('#no-category-filter-option .label').addClass('orange');
          $('a.category-filter.item').removeClass('active orange');
          $('a.category-filter.item .label').removeClass('orange');
        }
        else
        {
          $('#no-category-filter-option').removeClass('active orange');
          $('#no-category-filter-option .label').removeClass('orange');
        }

        var contacts = listContacts();

        console.log(categoryFilter);
        if (categoryFilter.length !== 0)
        {
          var filteredContacts = {};

          Object.keys(contacts).map(function(contact) {
            if (contacts[contact].categories.split(',').some(function(category) { return categoryFilter.includes(category); }))
              filteredContacts[contact] = contacts[contact];
          });

          contacts = filteredContacts;
        }

        $('#contact-list').html(renderContactList(contacts));

        if (Object.keys(contacts).length === 0)
          $('#no-contacts-modal').modal('show');

        $('.trash.icon').click(function(event) {
          event.preventDefault();
          event.stopPropagation();

          var contact = listContacts()[$(event.target).data('id')];

          $('#victim-id').val(contact.id);
          $('#victim-name').html(contact.name);

          $('#remove-contact-modal').modal('show');
          return false;
        });
      }

      function removeContact()
      {
        deleteContact($('#victim-id').val());
        $('#remove-contact-modal').modal('hide');
        refreshContacts();
      }
    </script>
  </body>
</html>
