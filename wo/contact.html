<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="semantic/dist/semantic.css" charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.js" charset="utf-8"></script>
    <script src="semantic/dist/semantic.js" charset="utf-8"></script>
    <script src="js/eseecard.js" charset="utf-8"></script>
    <title>Wö</title>
    <style>
      html, body {
        height: auto;
      }
      main {
        margin-top: 2.8em;
        margin-bottom: 3.8em;
        padding: 1em;
      }
      i.icon.hash:before {
        content: "\f292";
      }
    </style>
    <script type="text/javascript">
      var finishedLoading = false;

      function getPhoneNumbers()
      {
        return $('.phone.input').map(function(i, e) { return e.value }).get().join(',');
      }

      function getEmailAccounts()
      {
        return $('.email.input').map(function(i, e) { return e.value }).get().join(',');
      }

      function addPhoneInput(event, defValue='')
      {
        if (event)
        {
          event.stopPropagation();
          event.preventDefault();
        }

        $(event.target).parent().before(''
          + '<div class="field">'
            + '<div class="ui action input">'
              + '<input type="tel" class="phone input" value="' + defValue + '" oninput="enableSaveChanges();">'
              + '<button class="ui icon button" onclick="removePhoneOrEmail(event);"><i class="trash icon"></i></button>'
            + '</div>'
          + '</div>'
        );
      }

      var lastEmailId = 0;

      function addEmailInput(event, defValue='')
      {
        if (event)
        {
          event.stopPropagation();
          event.preventDefault();
        }

        $(event.target).parent().before(''
          + '<div class="field">'
            + '<div class="ui action input">'
              + '<input type="email" name="email' + lastEmailId + '" class="email input" value="' + defValue + '"  oninput="enableSaveChanges();">'
              + '<button class="ui icon button" onclick="removePhoneOrEmail(event);"><i class="trash icon"></i></button>'
            + '</div>'
          + '</div>'
        );

        lastEmailId++;

        if (!defValue)
          reconfigureForm();
      }

      function removePhoneOrEmail(event)
      {
        event.stopPropagation();
        event.preventDefault();

        $(event.target).closest('div.field').remove();
      }

      function saveContact()
      {
        $('#saveButton').addClass('loading');

        modifyCategories(function(categories) {
          $('#categories').dropdown('get value').split(',').forEach(function(category) {
            categories[category] = { name : category, id : category };
          });
          return categories;
        });

        modifyHashtags(function(hashtags) {
          $('#hashtags').dropdown('get value').split(',').forEach(function(hashtag) {
            hashtags[hashtag] = { name : hashtag, id : hashtag };
          });
          return hashtags;
        });

        updateContact({
          id          : $('#contact-id'    ).val(),
          name        : $('#name'          ).val(),
          location    : $('#location input').val(),
          position    : $('#position input').val(),
          company     : $('#company  input').val(),
          phone       : getPhoneNumbers(),
          email       : getEmailAccounts(),
          facebook    : $('#facebook'      ).val(),
          twitter     : $('#twitter'       ).val(),
          linkedin    : $('#linkedin'      ).val(),
          instagram   : $('#instagram'     ).val(),
          observations: $('#observations'  ).val(),
          categories  : $('#categories'    ).dropdown('get value'),
          hashtags    : $('#hashtags'      ).dropdown('get value')
        });

        addSearchTarget(companiesKey, $('#company  input').val());
        addSearchTarget(positionsKey, $('#position input').val());
        addSearchTarget(locationsKey, $('#location input').val());

        $('#contact-title').html($('#name').val());
        $('#saveButton').removeClass('loading').transition('fade right');
        $('#seeCard').addClass('primary');
      }

      var dropdownOptions = {
        allowAdditions: true,
        saveRemoteData: false,
        direction: 'upward',
        message: {
          addResult     : 'Crear categoría <strong>{term}</strong>',
          count         : '{count} seleccionados',
          maxSelections : '{maxCount} selecciones como máximo',
          noResults     : 'No se encontró resultados de búsqueda.'
        },
        onChange: enableSaveChanges
      };

      var hashtagOptions = {
        allowAdditions: true,
        saveRemoteData: false,
        direction: 'upward',
        message: {
          addResult     : 'Crear hashtag <strong>{term}</strong>',
          count         : '{count} seleccionados',
          maxSelections : '{maxCount} selecciones como máximo',
          noResults     : 'No se encontró resultados de búsqueda.'
        },
        onChange: enableSaveChanges
      };

      function backToContactList()
      {
        if ($('#saveButton').transition('is visible'))
          $('#exit-confirmation-modal').modal('show');
        else
          window.location = 'contact-list.html';
      }

      function enableSaveChanges()
      {
        if (finishedLoading && ! $('#saveButton').transition('is visible'))
        {
          $('#seeCard').removeClass('primary');
          $('#saveButton').transition('fade right in');
        }
      }

      function reconfigureForm()
      {
        var initConfig = {
          fields: {
            name : 'empty'
          },
          prompt: {
            empty : 'Escribe algo en este campo.',
            email : 'Escribe una dirección de correo electrónico correcta.'
          },
          inline: true,
          onSuccess: saveContact
        };

        $('.email.input').each(function(index, ei) {
          initConfig.fields[$(ei).attr('name')] = 'email';
        });

        $('.ui.form').form(initConfig);
      }

      $(document).ready(function() {
        var contact = listContacts()[getURLParameter('key')];

        $('#contact-id'    ).val(contact.id          );
        $('#name'          ).val(contact.name        );
        $('#location input').val(contact.location    );
        $('#position input').val(contact.position    );
        $('#company  input').val(contact.company     );
        $('#facebook'      ).val(contact.facebook    );
        $('#twitter'       ).val(contact.twitter     );
        $('#linkedin'      ).val(contact.linkedin    );
        $('#instagram'     ).val(contact.instagram   );
        $('#observations'  ).val(contact.observations);

        $('#contact-title').html(contact.name);

        $('#categories').dropdown(dropdownOptions);
        $('#hashtags'  ).dropdown( hashtagOptions);

        function makeEvent(target) {
          return {
            stopPropagation: function() {},
            preventDefault: function() {},
            target: target
          };
        };

        console.log(contact);

        contact
          .phone
          .split(',')
          .forEach(function(p) { addPhoneInput(makeEvent('#addPhone'), p) });

        contact
          .email
          .split(',')
          .forEach(function(m) {
            if (m !== '')
              addEmailInput(makeEvent('#addEmail'), m)
          });

        reconfigureForm();

        var contactCategories = (contact.categories === '') ? [] : contact.categories.split(',');
        var contactHashtags   = (contact.hashtags   === '') ? [] : contact.hashtags  .split(',');

        $('#categories').dropdown('set selected', contactCategories);
        $('#hashtags'  ).dropdown('set selected', contactHashtags  );

        $.fn.search.settings.minCharacters = 3;
        $.fn.search.settings.templates.message = function(message, type) { return ""; };

        $('#company' ).search({ source: searchArray(companiesKey) });
        $('#position').search({ source: searchArray(positionsKey) });
        $('#location').search({ source: searchArray(locationsKey) });

        $('#exit-confirmation-modal').modal({
          onApprove: function(element) {
            window.location = 'contact-list.html';
          },
          onDeny: function(modal) {
            $('#exit-confirmation-modal').modal('hide');
          }
        });
        finishedLoading = true;
      });
    </script>
  </head>
  <body>
    <div class="ui inverted blue top fixed borderless menu">
      <div class="item" onclick="backToContactList();"><i class="ui arrow left icon"></i></div>
      <div class="item" id="contact-title"></div>
    </div>
    <main>
      <form class="ui form">
        <input type="hidden" id="contact-id">
        <div class="field">
          <label><i class="user icon"></i> Nombre</label>
          <input type="text" id="name" placeholder="Nombre" oninput="enableSaveChanges();">
        </div>
        <div class="field">
          <label><i class="marker icon"></i> Ubicación</label>
          <div class="ui search" id="location">
            <input class="prompt" type="text" oninput="enableSaveChanges();">
            <div class="results"></div>
          </div>
        </div>
        <div class="field">
          <label><i class="travel icon"></i> Puesto o rol</label>
          <div class="ui search" id="position">
            <input class="prompt" type="text" oninput="enableSaveChanges();">
            <div class="results"></div>
          </div>
        </div>
        <div class="field">
          <label><i class="building icon"></i> Empresa</label>
          <div class="ui search" id="company">
            <input class="prompt" type="text" oninput="enableSaveChanges();">
            <div class="results"></div>
          </div>
        </div>
        <h4 class="ui orange horizontal divider header">Contacto</h4>
        <div class="field">
          <label>
            <i class="phone icon"></i>
            Números de teléfono
          </label>
        </div>
        <div class="field">
          <button id="addPhone" class="ui compact tiny button" onclick="addPhoneInput(event);"><i class="plus icon"></i> Agregar número</button>
        </div>

        <div class="field">
          <label>
            <i class="mail icon"></i>
            Correos electrónicos
          </label>
        </div>
        <div class="field">
          <button id="addEmail" class="ui compact tiny button" onclick="addEmailInput(event);"><i class="plus icon"></i> Agregar correo</button>
        </div>

        <h4 class="ui orange horizontal divider header">Redes sociales</h4>
        <div class="field">
          <label><i class="linkedin icon"></i> LinkedIn</label>
          <input type="text" id="linkedin" oninput="enableSaveChanges();">
        </div>
        <div class="field">
          <label><i class="facebook icon"></i> Facebook</label>
          <input type="text" id="facebook" oninput="enableSaveChanges();">
        </div>
        <div class="field">
          <label><i class="twitter icon"></i> Twitter</label>
          <input type="text" id="twitter" oninput="enableSaveChanges();">
        </div>
        <div class="field">
          <label><i class="instagram icon"></i> Instagram</label>
          <input type="text" id="instagram" oninput="enableSaveChanges();">
        </div>

        <h4 class="ui orange horizontal divider header">Otros datos</h4>
        <div class="field">
          <label><i class="tags icon"></i> Categorías</label>
          <script>
            document.write(renderCategoryDropdown('categories', 'categories'));
            $('#categories').dropdown(dropdownOptions);
          </script>
        </div>
        <div class="field">
          <label><i class="hash icon"></i> Hashtags</label>
          <script>
            document.write(renderHashtagsDropdown('hashtags', 'hashtags'));
            $('#hashtags').dropdown(hashtagOptions);
          </script>
        </div>
        <div class="field">
          <label><i class="comment icon"></i> Notas</label>
          <textarea id="observations" rows="3" oninput="enableSaveChanges();"></textarea>
        </div>
      </form>
    </main>
    <div class="ui bottom fixed borderless menu">
      <div class="right menu">
        <div class="item">
          <button id="saveButton" class="ui primary hidden transition compact button" onclick="$('.ui.form').form('validate form');" style="margin-right: 0.5em;"><i class="ui download icon"></i> Guardar</button>
          <button id="seeCard" class="ui primary compact button" onclick="window.location = 'card-page.html;"><i class="ui browser icon"></i> Ver tarjeta</button>
        </div>
      </div>
    </div>
    <div id="exit-confirmation-modal" class="ui modal">
      <div class="header">
        Datos sin guardar
      </div>
      <div class="content">
        <p>
          Usted ha modificado parte de este formulario, pero no ha guardado los
          cambios aún.
        </p>
        <p>
          ¿Desea deshacer los cambios realizados en este contacto?
        </p>
      </div>
      <div class="actions">
        <div class="ui primary approve button"><i class="checkmark icon"></i> Sí</div>
        <div class="ui button" onclick="$('.ui.form').form('validate form');"><i class="ui download icon"></i> Guardar</div>
        <div class="ui deny button"><i class="arrow left icon"></i> Volver al formulario</div>
      </div>
    </div>
  </body>
</html>
